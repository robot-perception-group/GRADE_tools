# Data Preprocess

This document will help you processing the data recorded during the experiments of the GRADE dataset.

There are many options.

The first choice you need to make is if you want to process the **rosbags** or the **full size data** (the saved `npy` files).
In the first case go to [ROSBAG Processing](), in the latter go to [File Processing]().

In practice, given an input folder, the script can:

- select the correct section of the rosbags (after the `starting_experiment` signal)
- correct the topic times of the bags to account for possible wrong clock times due to `isaac_sim` known issues
- add noise to the IMU and depths
- limit the recorded depth to a maximum distance
- add motion blur noise and rolling shutter effect to the RGB data
- extract rgb and depth PNG images
- extract odom and imu in npy files
- ...

The `process_data.sh` will take care of:

- reindexing the bag (if there is a `.bag.active`)
- start the correct processing script (located in `src/[file,bag]_process/play_[file,bags].py`)

---

## Procedure Overview

- In **Bag Processing**, **time correction** procedure will create `/reindex_bags` folder with reindex bags in your input folder
- In **Bag Processing**, **add noise** procedure will create the `/noisy_bags` folder with noisy bags in your input folder. The folder structure will be as follows:

  ```
    DATA_FOLDER/
      ├── *.bag                           # raw rosbags
      ├── Viewport0/                      # full size data in static scenario
      ├── Viewport0_occluded/             # full size data in dynamic scenario
      ├── reindex_bags/                   # generated by time correction
      └── noisy_bags/                     # generated by adding noise
  ```

- **Data Extraction** procedure is necessary for **file processing**, since IMU data and odom data are required when generating motion blur noise on full size RGB images
- **Data Extraction** procedure takes `/[reindex,noisy]_bags` as input and extract data with **similar resolution** from rosbags to the output directory as follows:

  ```
  reindex(noisy)_bags/
    ├── *.bag                           # processed bags from bag_processing
    └── data/                           # generated by data extraction
         ├─── depth(_noisy)/            # depth img in *.png
         ├─── depth_occluded(_noisy)/   # depth img with occlusion in *.png
         ├─── imu_body(_noisy)/         # imu-body data in *.npy
         ├─── imu_camera(_noisy)/       # imu-camera data in *.npy
         ├─── odom/                     # odom data in *.npy
         ├─── rgb(_noisy)/              # rgb img in *.png
         └─── rgb_occluded(_noisy)/     # rgb img with occlusion in *.png
  ```

  > When the input directory is **/noisy_bags**, the noisy data will be extracted from noisy bags.

- In **File Processing** procedure, noise will be added to **full size data** including rgb, depth and imu data
- **File Processing** procedure will take **depthLinear/rgb/camera** data from `Viewport[_occluded]` folder and **raw imu/odom** data from extracted data as inputs. The output folder structure is as follows:

  ```
  Viewport0(_occluded)/
    ├── (rgb, depthlinear, ...)         # original data
    └── data/                           # generated by file processing
         ├─── depth_image/              # full size depth img in *.png
         ├─── depth_noisy/              # full size depth noisy File in *.npy
         ├─── depth_noisy_image/        # full size depth noisy img  in *.png
         ├─── imu_body_noisy/           # imu-body noisy data in *.npy
         ├─── imu_camera_noisy/         # imu-camera noisy data in *.npy
         └─── rgb_noisy/                # rgb img with blur noise in *.png
  ```

---

## 1. ROSBAG Processing

```bash
./process_data.sh -t bag -p [PATH_TO_YOUR_DATA]
```

- Customized parameters are defined in `config/bag_process.yaml`. Please refer to that for the complete set of parameters.
  - If message timestamps are overlapped, set `time_correction/enable` to `True` to generate reindex bags.
  - Set `noise` to `True` to generate **Noisy Bags**
  - Set `camera/pointcloud` to `True` to generate **Pointcloud** in Noisy Bags
  - Set `blur/enable` to `True` to generate **Blurry Image** in Noisy Bags
- Reindex Bags will be saved in `/reindex_bags` folder
- Noisy Bags will be saved in `/noisy_bags` folder

## 2. Data Extraction

```bash
./process_data.sh -t extract -p [PATH_TO_YOUR_DATA]/[reindex,noisy]_bags
```

- Data extraction should be performed **after processing rosbags** and **before processing files**
- Input path should be `reindex_bags` to extract raw data or `noisy_bags` to extract noisy data
- Customized parameters are defined in `config/extract_data.yaml`
  - Set `save_images/enable` to `True` to save target rgb and depth PNG images (640X480)
  - Set `save_files/enable` to `True` to save target odom/imu data in \*npy files

## 3. File Processing

```bash
./process_data.sh -t file -p [PATH_TO_YOUR_DATA]/Viewport
```

- Customized parameters are defined in `config/file_process.yaml`
  - Set `camera/enable` to `True` to generate **Noisy Depth files** in \*npy files (1920X1080)
  - Set `camera/output_img` to `True` to generate **Original and Noisy Depth Images** in \*.png files (1920X1080)
  - Set `blur/enable` to `True` to generate **Blurry RGB Images** in \*.png files (1920X1080)
  - Set `imu/enable` to `True` to generate **Noisy IMU Data** in \*.npy files

#### Example:

```bash
./process_data.sh -t file -p ~/exp/Viewport0/
```
